<!DOCTYPE html>
<html>

<head>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>

<body>
    <!-- The <div> that the YouTube API will convert into an <iframe> -->
    <div id="player"></div>

    <script>
        // --- 1. Load YouTube IFrame Player API asynchronously ---
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        var player;
        var isPlayerReady = false;
        var pendingVideoId = null;

        // --- 2. Parse Initial Video ID ---
        const urlParams = new URLSearchParams(window.location.search);
        // Default to a safe placeholder if none provided
        var initialVideoId = urlParams.get('v') || 'QiemgC39tA0';

        // --- 3. API Callback: Called when API is ready ---
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                videoId: initialVideoId,
                playerVars: {
                    'autoplay': 1,
                    'controls': 1,
                    'rel': 0,
                    'modestbranding': 1,
                    'origin': 'https://app.local' // Important for API security
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        var progressInterval;

        // --- 4. Player Ready Event ---
        function onPlayerReady(event) {
            isPlayerReady = true;
            // event.target.playVideo(); // Autoplay should handle it, but this reinforces it

            // If we received a request while loading, handle it now
            if (pendingVideoId) {
                // If pending has start time, use it
                if (typeof pendingVideoId === 'object') {
                    loadAppVideo(pendingVideoId.videoId, pendingVideoId.startTime);
                } else {
                    loadAppVideo(pendingVideoId);
                }
                pendingVideoId = null;
            }
        }

        function onPlayerStateChange(event) {
            // YT.PlayerState.PLAYING is 1
            if (event.data === 1) {
                startProgressTracking();
            } else {
                stopProgressTracking();
            }

            // YT.PlayerState.ENDED is 0
            if (event.data === 0) {
                stopProgressTracking();
                if (window.chrome && window.chrome.webview) {
                    window.chrome.webview.postMessage("VIDEO_ENDED");
                }
            }
        }

        function startProgressTracking() {
            stopProgressTracking();
            progressInterval = setInterval(function () {
                if (player && player.getCurrentTime) {
                    var currentTime = player.getCurrentTime();
                    var duration = player.getDuration();
                    if (window.chrome && window.chrome.webview) {
                        // Format: PROGRESS:currentTime|duration
                        window.chrome.webview.postMessage("PROGRESS:" + currentTime + "|" + duration);
                    }
                }
            }, 3000); // Update every 3 seconds
        }

        function stopProgressTracking() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
        }

        // --- 5. Global Function called by C# Host ---
        // Usage: await webView.CoreWebView2.ExecuteScriptAsync("loadAppVideo('NEW_ID', startSeconds)");
        window.loadAppVideo = function (videoId, startSeconds) {
            if (!videoId) return;

            if (isPlayerReady && player && player.loadVideoById) {
                console.log("Loading Video via JS API: " + videoId + " at " + startSeconds);
                var loadObj = {
                    'videoId': videoId
                };
                if (startSeconds) {
                    loadObj['startSeconds'] = startSeconds;
                }
                player.loadVideoById(loadObj);
            } else {
                console.log("Player not ready, queuing: " + videoId);
                pendingVideoId = { videoId: videoId, startTime: startSeconds };
            }
        };
    </script>
</body>

</html>